name: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è Nexus Digital

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–¥—É
      uses: actions/checkout@v4

    - name: 2. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: 3. –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ö–æ—Å—Ç–∞ –¥–æ known_hosts
      run: |
        ssh-keyscan -H 164.90.234.176 >> ~/.ssh/known_hosts

    - name: 4. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è SSH –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
      run: |
        ssh -o ConnectTimeout=10 nexususer@164.90.234.176 "echo 'SSH –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–µ'"

    - name: 5. –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      run: |
        ssh nexususer@164.90.234.176 << 'EOF'
          echo "üöÄ –ü–æ—á–∞—Ç–æ–∫ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è..."
          
          # –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ—î–∫—Ç—É
          cd /home/nexususer/nexus-digital-web || exit 1
          
          # –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–∏—Ö –∑–º—ñ–Ω (—è–∫—â–æ —î)
          git stash
          
          # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É
          echo "üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥—É..."
          git fetch origin
          git reset --hard origin/main
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
          echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
          npm ci --production
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–æ–¥–∞—Ç–∫—É..."
          npm run production || {
            echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É –¥–æ–¥–∞—Ç–∫—É"
            exit 1
          }
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx
          echo "üåê –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞..."
          sudo systemctl reload nginx
          
          echo "‚úÖ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
        EOF

    - name: 6. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É —Å–∞–π—Ç—É
      run: |
        echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Å–∞–π—Ç—É..."
        curl -f http://164.90.234.176 || echo "‚ö†Ô∏è –°–∞–π—Ç –ø–æ–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –∞–ª–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
