name: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è Nexus Digital

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: 1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–¥—É
      uses: actions/checkout@v4

    - name: 2. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SSH –∫–ª—é—á–∞
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: 3. –î–æ–¥–∞–≤–∞–Ω–Ω—è —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 164.90.234.176 >> ~/.ssh/known_hosts

    - name: 4. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è SSH –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
      run: |
        echo "üîç –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è SSH –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è..."
        ssh -o ConnectTimeout=30 -o BatchMode=yes nexususer@164.90.234.176 "echo 'SSH –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–µ'"

    - name: 5. –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      run: |
        echo "üöÄ –ü–æ—á–∞—Ç–æ–∫ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è..."
        ssh -o ConnectTimeout=30 nexususer@164.90.234.176 'bash -s' << 'ENDSSH'
          set -e  # –ó—É–ø–∏–Ω–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –ø–æ–º–∏–ª—Ü—ñ
          
          echo "üìÇ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ—î–∫—Ç—É..."
          PROJECT_DIR="/home/nexususer/nexus-digital-web"
          
          # –°—Ç–≤–æ—Ä–∏—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
          if [ ! -d "$PROJECT_DIR" ]; then
            echo "üìÅ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ—î–∫—Ç—É..."
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            git clone https://github.com/Danylo-Molianko/nexus-digital.git .
          else
            echo "üì• –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É..."
            cd "$PROJECT_DIR"
            
            # –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω
            if [ -n "$(git status --porcelain)" ]; then
              echo "üíæ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω..."
              git stash
            fi
            
            # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ GitHub
            git fetch origin
            git reset --hard origin/main
          fi
          
          echo "üì¶ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ package.json..."
          if [ ! -f "package.json" ]; then
            echo "üìù –°—Ç–≤–æ—Ä–µ–Ω–Ω—è package.json..."
            cat > package.json << 'EOF'
        {
          "name": "nexus-digital",
          "version": "1.0.0",
          "description": "Nexus Digital - AI & Web Development",
          "main": "server.js",
          "scripts": {
            "start": "node server.js",
            "production": "pm2 restart nexus-digital || pm2 start server.js --name nexus-digital",
            "stop": "pm2 stop nexus-digital || true"
          },
          "dependencies": {
            "express": "^4.18.2"
          }
        }
        EOF
          fi
          
          echo "üñ•Ô∏è –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ server.js..."
          if [ ! -f "server.js" ]; then
            echo "üìù –°—Ç–≤–æ—Ä–µ–Ω–Ω—è server.js..."
            cat > server.js << 'EOF'
        const express = require('express');
        const path = require('path');
        const app = express();
        const PORT = process.env.PORT || 8080;
        
        console.log('üöÄ –ó–∞–ø—É—Å–∫ Nexus Digital —Å–µ—Ä–≤–µ—Ä–∞...');
        
        app.use(express.static(path.join(__dirname, 'public')));
        app.use('/assets', express.static(path.join(__dirname, 'assets')));
        
        app.get('/', (req, res) => {
            res.sendFile(path.join(__dirname, 'public', 'index.html'));
        });
        
        app.use((req, res) => {
            res.status(404).sendFile(path.join(__dirname, 'public', 'index.html'));
        });
        
        app.listen(PORT, '0.0.0.0', () => {
            console.log(`‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
        });
        EOF
          fi
          
          echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
          if command -v npm >/dev/null 2>&1; then
            npm install --production
          else
            echo "‚ùå npm –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –≤—Å—Ç–∞–Ω–æ–≤–ª—é–π—Ç–µ Node.js"
            exit 1
          fi
          
          echo "üîÑ –ó–∞–ø—É—Å–∫/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
          if command -v pm2 >/dev/null 2>&1; then
            npm run production
            echo "‚úÖ PM2 —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ"
          else
            echo "‚ö†Ô∏è PM2 –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ nohup..."
            pkill -f "node server.js" || true
            nohup node server.js > server.log 2>&1 &
            echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ"
          fi
          
          echo "üåê –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx..."
          if command -v nginx >/dev/null 2>&1; then
            sudo systemctl reload nginx || echo "‚ö†Ô∏è Nginx –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –Ω–µ –≤–¥–∞–≤—Å—è"
          else
            echo "‚ö†Ô∏è Nginx –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
          fi
          
          echo "‚úÖ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
        ENDSSH

    - name: 6. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
      run: |
        echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Å–∞–π—Ç—É..."
        sleep 5
        if curl -f -s http://164.90.234.176 > /dev/null; then
          echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–Ω–∏–π!"
        else
          echo "‚ö†Ô∏è –°–∞–π—Ç –ø–æ–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –∞–ª–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
        fi
