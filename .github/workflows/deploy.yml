name: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è Nexus Digital

on:
  push:
    # –ó–∞–ø—É—Å–∫–∞—Ç–∏ –ø—Ä–∏ –≤–∏–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∫–æ–¥—É –≤ –≥–æ–ª–æ–≤–Ω—É –≥—ñ–ª–∫—É 'main'
    branches:
      - main
  # –î–æ–∑–≤–æ–ª–∏—Ç–∏ —Ä—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É GitHub
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: 1. –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–¥—É
      uses: actions/checkout@v4

    - name: 2. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è SSH –¥–ª—è Droplet
      uses: webfactory/ssh-agent@v0.9.0
      with:
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –Ω–∞—à –°–µ–∫—Ä–µ—Ç–Ω–∏–π –∫–ª—é—á SSH_PRIVATE_KEY
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        # Droplet IP (–¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ —Ö–æ—Å—Ç–∞)
        known-hosts: 164.90.234.176 

    - name: 3. –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Ç–∞ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –°–µ—Ä–≤—ñ—Å—ñ–≤
      # –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥ –Ω–∞ Droplet —á–µ—Ä–µ–∑ SSH
      run: |
        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–º—ñ–Ω–Ω—ñ
        SSH_HOST="nexususer@164.90.234.176" 
        REMOTE_DIR="/home/nexususer/nexus-digital-web"
        
        # –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞ —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥
        ssh -o StrictHostKeyChecking=no $SSH_HOST << 'EOF'
          echo "–ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É..."
          cd $REMOTE_DIR
          
          echo "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–¥—É –∑ GitHub..."
          git pull
          
          echo "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ npm install --production –¥–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó
          npm install --production
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É Node.js –Ω–∞ –ø–æ—Ä—Ç—É 8080 —á–µ—Ä–µ–∑ PM2
          echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É Node.js..."
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ–º–∞–Ω–¥—É –∑ package.json
          npm run production
          
          # –§—ñ–Ω–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx (–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ–≤–Ω–∏–π —à–ª—è—Ö, –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π NOPASSWD)
          echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx..."
          sudo /usr/sbin/service nginx restart
          
          echo "‚úÖ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
        EOF
            log_info "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –ø—Ä–æ—î–∫—Ç—É..."
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            
            # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
            if ! git clone https://github.com/Danylo-Molianko/nexus-digital.git . 2>/dev/null; then
              log_warn "–ö–ª–æ–Ω—É–≤–∞–Ω–Ω—è –Ω–µ –≤–¥–∞–ª–æ—Å—è, —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π..."
              git init
              git remote add origin https://github.com/Danylo-Molianko/nexus-digital.git
            fi
          else
            log_info "–û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É..."
            cd "$PROJECT_DIR"
            
            # –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω
            if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
              log_info "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∑–º—ñ–Ω..."
              git stash || log_warn "–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏"
            fi
            
            # –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ GitHub
            log_info "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –∑–º—ñ–Ω..."
            git fetch origin main || log_warn "Fetch –Ω–µ –≤–¥–∞–≤—Å—è"
            git reset --hard origin/main || git reset --hard HEAD
          fi
          
          # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è package.json —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
          if [ ! -f "package.json" ]; then
            log_info "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è package.json..."
            cat > package.json << 'PACKAGE_JSON'
        {
          "name": "nexus-digital",
          "version": "1.0.0",
          "description": "Nexus Digital Website",
          "main": "server.js",
          "scripts": {
            "start": "node server.js",
            "production": "pm2 restart nexus-digital || pm2 start server.js --name nexus-digital",
            "stop": "pm2 stop nexus-digital || true"
          },
          "dependencies": {
            "express": "^4.18.2"
          }
        }
        PACKAGE_JSON
          fi
          
          # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è server.js —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
          if [ ! -f "server.js" ]; then
            log_info "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è server.js..."
            cat > server.js << 'SERVER_JS'
        const express = require('express');
        const path = require('path');
        const app = express();
        const PORT = process.env.PORT || 8080;
        
        console.log('üöÄ –ó–∞–ø—É—Å–∫ Nexus Digital...');
        
        // –°—Ç–∞—Ç–∏—á–Ω—ñ —Ñ–∞–π–ª–∏
        app.use(express.static(path.join(__dirname, 'public')));
        app.use('/assets', express.static(path.join(__dirname, 'assets')));
        
        // –û—Å–Ω–æ–≤–Ω–∏–π –º–∞—Ä—à—Ä—É—Ç
        app.get('/', (req, res) => {
            const indexPath = path.join(__dirname, 'public', 'index.html');
            res.sendFile(indexPath, (err) => {
                if (err) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª—É:', err);
                    res.status(500).send('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
            });
        });
        
        // –û–±—Ä–æ–±–∫–∞ –≤—Å—ñ—Ö —ñ–Ω—à–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤
        app.get('*', (req, res) => {
            const indexPath = path.join(__dirname, 'public', 'index.html');
            res.sendFile(indexPath, (err) => {
                if (err) {
                    res.status(404).send('–°—Ç–æ—Ä—ñ–Ω–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞');
                }
            });
        });
        
        // –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
        app.listen(PORT, '0.0.0.0', () => {
            console.log(`‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}`);
            console.log(`üåê –î–æ—Å—Ç—É–ø–Ω–æ: http://localhost:${PORT}`);
        });
        SERVER_JS
          fi
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Node.js —è–∫—â–æ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
          if ! command -v node >/dev/null 2>&1; then
            log_warn "Node.js –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
          log_info "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
          if command -v npm >/dev/null 2>&1; then
            npm install --production --no-audit --no-fund
          else
            log_error "npm –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
            exit 1
          fi
          
          # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è PM2 —è–∫—â–æ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
          if ! command -v pm2 >/dev/null 2>&1; then
            log_info "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è PM2..."
            sudo npm install -g pm2
          fi
          
          # –ó–∞–ø—É—Å–∫/–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
          log_info "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
          if pm2 describe nexus-digital >/dev/null 2>&1; then
            log_info "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —ñ—Å–Ω—É—é—á–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É..."
            pm2 restart nexus-digital
          else
            log_info "–ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É..."
            pm2 start server.js --name nexus-digital
          fi
          
          # –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó PM2
          pm2 save
          pm2 startup | tail -1 | sudo sh || log_warn "PM2 startup –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ"
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx —è–∫—â–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
          if command -v nginx >/dev/null 2>&1; then
            log_info "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx..."
            sudo systemctl reload nginx || log_warn "Nginx reload –Ω–µ –≤–¥–∞–≤—Å—è"
          fi
          
          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
          log_info "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –¥–æ–¥–∞—Ç–∫—É..."
          if pm2 describe nexus-digital | grep -q "online"; then
            log_info "‚úÖ –î–æ–¥–∞—Ç–æ–∫ –ø—Ä–∞—Ü—é—î –æ–Ω–ª–∞–π–Ω"
          else
            log_warn "‚ö†Ô∏è –î–æ–¥–∞—Ç–æ–∫ –º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –Ω–µ —Å—Ç–∞–±—ñ–ª—å–Ω–æ"
          fi
          
          log_info "üéâ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!"
        ENDSSH

    - name: 6. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É —Å–∞–π—Ç—É
      run: |
        echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Å–∞–π—Ç—É..."
        sleep 10
        
        # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑ —Ç–∞–π–º-–∞—É—Ç–æ–º
        if timeout 30 bash -c 'until curl -f -s http://164.90.234.176 >/dev/null; do sleep 2; done'; then
          echo "‚úÖ –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ –∞–¥—Ä–µ—Å–æ—é: http://164.90.234.176"
        else
          echo "‚ö†Ô∏è –°–∞–π—Ç –ø–æ–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, –∞–ª–µ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
          echo "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤—Ä—É—á–Ω—É"
        fi

    - name: 7. –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å PM2
      run: |
        echo "üìä –°—Ç–∞—Ç—É—Å –¥–æ–¥–∞—Ç–∫—ñ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ:"
        ssh nexususer@164.90.234.176 "pm2 list || echo 'PM2 –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π'"
      continue-on-error: true
