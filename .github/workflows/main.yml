name: Build and Deploy Nexus Studio (Production)

on:
  push:
    branches:
      - main # –ó–∞–ø—É—Å–∫–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ push –≤ main

jobs:
  # --- 1. –†–û–ë–û–¢–ê: –ó–ë–Ü–†–ö–ê ---
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project (Production)
      run: npm run build

    - name: Archive production artifacts
      # [–Ü–î–ï–ê–õ–¨–ù–ò–ô –ö–†–û–ö] –ó–±–µ—Ä—ñ–≥–∞—î–º–æ 'dist' –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ—ó —Ä–æ–±–æ—Ç–∏
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: dist/
        retention-days: 1

  # --- 2. –†–û–ë–û–¢–ê: –†–û–ó–ì–û–†–¢–ê–ù–ù–Ø (DEPLOYMENT) ---
  deploy:
    needs: build # –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∑–±—ñ—Ä–∫–∏
    runs-on: ubuntu-latest

    steps:
    - name: Download production artifacts
      # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ 'dist', —è–∫–∏–π –∑—ñ–±—Ä–∞–ª–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—è —Ä–æ–±–æ—Ç–∞
      uses: actions/download-artifact@v4
      with:
        name: production-build
        path: dist/

    - name: üöÄ Deploy to Production Server
      # [–Ü–î–ï–ê–õ–¨–ù–ò–ô –ö–†–û–ö] –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ SSH –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –¢–ê –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # [–Ü–î–ï–ê–õ–¨–ù–ò–ô –ö–†–û–ö 1: –ö–û–ü–Ü–Æ–í–ê–ù–ù–Ø]
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
          cd ${{ secrets.PROJECT_DIR }}
          
          # –í–∏–¥–∞–ª—è—î–º–æ –°–¢–ê–†–£ –ø–∞–ø–∫—É 'dist'
          echo "Removing old build directory..."
          rm -rf dist
          
          # –°—Ç–≤–æ—Ä—é—î–º–æ –ù–û–í–£ –ø–æ—Ä–æ–∂–Ω—é –ø–∞–ø–∫—É 'dist'
          mkdir dist
          echo "Created new build directory."

    - name: Sync 'dist' folder to server
      # [–Ü–î–ï–ê–õ–¨–ù–ò–ô –ö–†–û–ö 2: –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–Ø]
      # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ 'scp' –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –Ω–∞—à–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤
      # —É –ù–û–í–£ –ø–∞–ø–∫—É 'dist' –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        source: "dist/*" # –ö–æ–ø—ñ—é—î–º–æ –≤–º—ñ—Å—Ç 'dist'
        target: "${{ secrets.TARGET_DIR }}" # –£ —Ü—ñ–ª—å–æ–≤—É –ø–∞–ø–∫—É
        strip_components: 1 # –ù–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ 'dist/dist', –∞ –∫–ª–∞—Å—Ç–∏ —Ñ–∞–π–ª–∏ –ø—Ä—è–º–æ

    - name: üîÑ Restart Production Server
      # [–Ü–î–ï–ê–õ–¨–ù–ò–ô –ö–†–û–ö 3: –ü–ï–†–ï–ó–ê–ü–£–°–ö]
      # –¶–µ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∏–π –∫—Ä–æ–∫. –ú–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å 'node'
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # –ú–∏ –ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ –ø—Ä–æ—Ü–µ—Å –∫–µ—Ä—É—î—Ç—å—Å—è 'pm2'
          # —ñ –π–æ–≥–æ –Ω–∞–∑–≤–∞ 'nexus_app' (—è–∫ —É Nginx-–∫–æ–Ω—Ñ—ñ–≥—É)
          # –Ø–∫—â–æ —Ü–µ –Ω–µ —Ç–∞–∫, —Ü–µ–π –∫—Ä–æ–∫ –ø—Ä–æ–≤–∞–ª–∏—Ç—å—Å—è, —ñ –º–∏ –π–æ–≥–æ –≤–∏–ø—Ä–∞–≤–∏–º–æ
          echo "Restarting application server..."
          export PATH=$PATH:/home/nexususer/.nvm/versions/node/v18.18.2/bin # –í–∫–∞–∑—É—î–º–æ —à–ª—è—Ö –¥–æ pm2
          pm2 restart nexus_app
          
          echo "‚úÖ Production Deployment Successful!"