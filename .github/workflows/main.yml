name: CI Build (No Deploy)

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # --- 1. –†–û–ë–û–¢–ê: –ó–ë–Ü–†–ö–ê (–ë–µ–∑ –∑–º—ñ–Ω) ---
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project (Production)
      run: npm run build

    - name: Archive production artifacts
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: dist/
        retention-days: 1

  # –í–∏–¥–∞–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–∫—à–Ω-—Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∑ —Ü—å–æ–≥–æ workflow. –ü—Ä–æ–¥–∞–∫—à–Ω –¥–µ–ø–ª–æ–π –≤–∏–∫–æ–Ω—É—î .github/workflows/deploy.yml (Docker Compose).
        strip_components: 1 # –ù–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ 'dist/dist', –∞ –∫–ª–∞—Å—Ç–∏ —Ñ–∞–π–ª–∏ –ø—Ä—è–º–æ
        overwrite: true

    - name: üîÑ Restart Production Server
      # [–Ü–î–ï–ê–õ–¨–ù–ò–ô –ö–†–û–ö 2: –ü–ï–†–ï–ó–ê–ü–£–°–ö]
      # –¶–µ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∏–π –∫—Ä–æ–∫. –ú–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å 'node'
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
          cd ${{ secrets.PROJECT_DIR }}
          
          # –ú–∏ –ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ –ø—Ä–æ—Ü–µ—Å –∫–µ—Ä—É—î—Ç—å—Å—è 'pm2'
          # —ñ –π–æ–≥–æ –Ω–∞–∑–≤–∞ 'nexus_app' (—è–∫ —É Nginx-–∫–æ–Ω—Ñ—ñ–≥—É)
          echo "Restarting application server..."
          
          # –í–∫–∞–∑—É—î–º–æ —à–ª—è—Ö –¥–æ pm2. 
          # –¶–µ–π —à–ª—è—Ö –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—å, —è–∫—â–æ pm2 –Ω–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É $PATH
          # export PATH=$PATH:/home/nexususer/.nvm/versions/node/v18.18.2/bin
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å
          pm2 restart nexus_app
          
          echo "‚úÖ Production Deployment Successful!"