name: Build and Deploy Nexus Studio (Production - Direct SSH/SCP + Debug)

on:
  push:
    branches:
      - main # –ó–∞–ø—É—Å–∫–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ push –≤ main

jobs:
  # --- 1. –†–û–ë–û–¢–ê: –ó–ë–Ü–†–ö–ê (–ë–µ–∑ –∑–º—ñ–Ω) ---
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Use Node.js 18.x
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project (Production)
      run: npm run build

    - name: Archive production artifacts
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: dist/
        retention-days: 1

  # --- 2. –†–û–ë–û–¢–ê: –†–û–ó–ì–û–†–¢–ê–ù–ù–Ø (DEPLOYMENT - –ù–û–í–ê –°–¢–†–ê–¢–ï–ì–Ü–Ø) ---
  deploy:
    needs: build # –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –∑–±—ñ—Ä–∫–∏
    runs-on: ubuntu-latest

    steps:
    # [–ù–û–í–ò–ô –î–Ü–ê–ì–ù–û–°–¢–ò–ß–ù–ò–ô –ö–†–û–ö] –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ —Å–µ–∫—Ä–µ—Ç—É
    - name: "Debug: Print SSH_HOST Secret"
      run: |
        echo "Attempting to print host: [${{ secrets.SSH_HOST }}]"

    - name: Download production artifacts
      uses: actions/download-artifact@v4
      with:
        name: production-build
        path: dist/ # –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —É –ø–∞–ø–∫—É 'dist'

    - name: ‚öôÔ∏è Setup SSH Key
      # [–ù–û–í–ò–ô –ö–†–û–ö] –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ SSH –≤—Ä—É—á–Ω—É, —â–æ–± –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ –¥–æ—Å—Ç—É–ø
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa # –ö–ª–∞–¥–µ–º–æ –∫–ª—é—á –∑ —Å–µ–∫—Ä–µ—Ç—ñ–≤
        chmod 600 ~/.ssh/id_rsa # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ –¥–æ–∑–≤–æ–ª–∏
        ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts # –î–æ–¥–∞—î–º–æ —Ö–æ—Å—Ç –¥–æ –≤—ñ–¥–æ–º–∏—Ö

    - name: üöÄ Deploy Files via SCP (Direct)
      # [–ù–û–í–ò–ô –ö–†–û–ö] –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –±–∞–∑–æ–≤—É –∫–æ–º–∞–Ω–¥—É scp
      run: |
        echo "Copying build files to server..."
        scp -r dist/* ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }}:${{ secrets.TARGET_DIR }}
        echo "‚úÖ Files copied successfully!"

    - name: üîÑ Restart Production Server (Direct SSH)
      # [–ù–û–í–ò–ô –ö–†–û–ö] –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –±–∞–∑–æ–≤—É –∫–æ–º–∞–Ω–¥—É ssh –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É
      run: |
        echo "Connecting to server to restart application..."
        ssh ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
          # –ö–æ–º–∞–Ω–¥–∏, —â–æ –≤–∏–∫–æ–Ω–∞—é—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
          echo "Changing to project directory..."
          cd ${{ secrets.PROJECT_DIR }}
          
          echo "Restarting application with pm2..."
          # export PATH=$PATH:/home/nexususer/.nvm/versions/node/v18.18.2/bin # –Ø–∫—â–æ pm2 –Ω–µ –≤ PATH
          pm2 restart nexus_app
          
          echo "‚úÖ Application restarted successfully!"
        EOF # –ö—ñ–Ω–µ—Ü—å –∫–æ–º–∞–Ω–¥ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
        strip_components: 1 # –ù–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ 'dist/dist', –∞ –∫–ª–∞—Å—Ç–∏ —Ñ–∞–π–ª–∏ –ø—Ä—è–º–æ
        overwrite: true

    - name: üîÑ Restart Production Server
      # [–Ü–î–ï–ê–õ–¨–ù–ò–ô –ö–†–û–ö 2: –ü–ï–†–ï–ó–ê–ü–£–°–ö]
      # –¶–µ –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–∏–π –∫—Ä–æ–∫. –ú–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å 'node'
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
          cd ${{ secrets.PROJECT_DIR }}
          
          # –ú–∏ –ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ –ø—Ä–æ—Ü–µ—Å –∫–µ—Ä—É—î—Ç—å—Å—è 'pm2'
          # —ñ –π–æ–≥–æ –Ω–∞–∑–≤–∞ 'nexus_app' (—è–∫ —É Nginx-–∫–æ–Ω—Ñ—ñ–≥—É)
          echo "Restarting application server..."
          
          # –í–∫–∞–∑—É—î–º–æ —à–ª—è—Ö –¥–æ pm2. 
          # –¶–µ–π —à–ª—è—Ö –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—å, —è–∫—â–æ pm2 –Ω–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É $PATH
          # export PATH=$PATH:/home/nexususer/.nvm/versions/node/v18.18.2/bin
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å
          pm2 restart nexus_app
          
          echo "‚úÖ Production Deployment Successful!"